<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Control de Lotes</title>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <style>
            body {
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 24px;
                background-color: #F7F6F3; /* Fondo gris claro de Notion */
                color: #2F3437; /* Texto oscuro */
                line-height: 1.6;
            }
    
            h1, h2, h3 {
                color: #1A1A1A; /* Color más oscuro para títulos */
                font-weight: 600;
            }
    
            h1 {
                text-align: center;
                font-size: 28px;
                margin-bottom: 32px;
            }
    
            h2 {
                font-size: 22px;
                margin-top: 32px;
                margin-bottom: 16px;
            }
    
            h3 {
                font-size: 18px;
                margin-bottom: 12px;
            }
    
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: #FFFFFF;
                padding: 32px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Sombra suave */
            }
    
            .form-group {
                margin-bottom: 16px;
            }
    
            label {
                display: block;
                margin-bottom: 6px;
                font-size: 13px;
                font-weight: 500;
                color: #37352F; /* Color oscuro para etiquetas */
            }
    
            input, select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #E0E0E0; /* Borde gris claro */
                border-radius: 4px;
                font-size: 14px;
                background-color: #FFFFFF;
                box-sizing: border-box;
                transition: border-color 0.2s, box-shadow 0.2s;
            }
    
            input:focus, select:focus {
                border-color: #40C4FF; /* Azul claro de Notion */
                box-shadow: 0 0 0 2px rgba(64, 196, 255, 0.1);
                outline: none;
            }
    
            #lotId {
                border: 1px solid #40C4FF;
                background-color: #F5FAFF; /* Fondo azul claro */
                font-size: 16px;
                padding: 12px;
            }
    
            #lotId:focus {
                background-color: #E8F4FF;
            }
    
            button {
                padding: 10px 16px;
                background-color: #37352F; /* Gris oscuro */
                color: #FFFFFF;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: background-color 0.2s;
            }
    
            button:hover {
                background-color: #2A2926; /* Gris más oscuro al hover */
            }
    
            .tabs {
                display: flex;
                background-color: #F2F1ED; /* Fondo gris claro */
                padding: 4px;
                border-radius: 6px;
                margin-bottom: 24px;
            }
    
            .tab-button {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 8px 16px;
                background: none;
                border: none;
                cursor: pointer;
                font-size: 14px;
                color: #787774; /* Texto gris */
                border-radius: 4px;
                transition: background-color 0.2s, color 0.2s;
            }
    
            .tab-button.active {
                background-color: #FFFFFF;
                color: #1A1A1A;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }
    
            .tab-button:hover {
                background-color: #EDECE8;
                color: #1A1A1A;
            }
    
            .tab-content {
                display: none;
            }
    
            .tab-content.active {
                display: block;
            }
    
            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                margin-top: 16px;
                background-color: #FFFFFF;
                border-radius: 6px;
                overflow: hidden;
            }
    
            th {
                background-color: #F2F1ED; /* Fondo gris claro para encabezados */
                color: #37352F;
                font-weight: 500;
                font-size: 13px;
                padding: 12px 16px;
                text-align: left;
                border-bottom: 1px solid #E0E0E0;
            }
    
            td {
                padding: 12px 16px;
                border-bottom: 1px solid #E8E8E8;
                color: #2F3437;
                font-size: 14px;
            }
    
            tr:last-child td {
                border-bottom: none;
            }
    
            tr:hover {
                background-color: #F5FAFF; /* Fondo azul claro al hover */
            }
    
            tr.selected {
                background-color: #E8F4FF; /* Fondo azul claro para selección */
            }
    
            .status-devuelto-text {
                color: #F4A261; /* Naranja suave */
            }
    
            .table-container {
                overflow-x: auto;
            }
    
            .counter {
                margin: 24px 0;
                padding: 16px;
                background-color: #FFFFFF;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
    
            .counter p {
                font-size: 14px;
                font-weight: 500;
                color: #37352F;
                margin: 8px 0;
            }
    
            .reset-button, .export-button {
                background-color: #EB5757; /* Rojo suave */
                margin-top: 8px;
            }
    
            .export-button {
                background-color: #2ECC71; /* Verde suave */
                margin-left: 8px;
            }
    
            .reset-button:hover, .export-button:hover {
                background-color: #D14343; /* Rojo más oscuro */
            }
    
            .export-button:hover {
                background-color: #27AE60; /* Verde más oscuro */
            }
    
            #sellerInputContainer {
                margin-bottom: 12px;
            }
    
            .seller-input {
                display: flex;
                align-items: center;
                margin-bottom: 12px;
                gap: 8px;
            }
    
            .seller-input input {
                flex: 1;
            }
    
            .remove-seller {
                background-color: #EB5757;
                padding: 8px 12px;
            }
    
            .remove-seller:hover {
                background-color: #D14343;
            }
    
            .search-bar {
                margin-bottom: 24px;
            }
    
            .search-bar input {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #E0E0E0;
                border-radius: 4px;
                font-size: 14px;
            }
    
            .form-box {
                background-color: #FFFFFF;
                padding: 24px;
                border-radius: 6px;
                margin-bottom: 24px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
    
            .button-group {
                display: flex;
                gap: 8px;
                margin-top: 24px;
            }
    
            .payment-details {
                display: none;
                margin-top: 12px;
            }
    
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.4);
                align-items: center;
                justify-content: center;
            }
    
            .modal-content {
                background-color: #FFFFFF;
                padding: 24px;
                border-radius: 6px;
                width: 400px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
    
            .close-modal {
                float: right;
                cursor: pointer;
                font-size: 20px;
                color: #787774;
            }
    
            .close-modal:hover {
                color: #37352F;
            }
    
            .return-button {
                background-color: #F4A261; /* Naranja suave */
                margin-top: 12px;
            }
    
            .return-button:hover {
                background-color: #E88C30; /* Naranja más oscuro */
            }
    
            #lotDetails {
                display: none;
                margin-top: 24px;
                padding: 16px;
                border: 1px solid #E0E0E0;
                border-radius: 6px;
                background-color: #FAFAFA;
            }
    
            #lotStatusLabel {
                display: none;
                margin-bottom: 12px;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 13px;
                font-weight: 500;
                line-height: 1.4;
            }
    
            .status-disponible {
                background-color: #E6F4EA; /* Verde suave */
                color: #2E7D32;
            }
    
            .status-en-pagos {
                background-color: #FFF4E5; /* Amarillo suave */
                color: #F57C00;
            }
    
            .status-no-disponible {
                background-color: #FFEBEE; /* Rojo suave */
                color: #D32F2F;
            }
    
            .status-vendido {
                background-color: #E8F4FF; /* Azul suave */
                color: #1565C0;
            }
    
            #detailBalance {
                color: #D32F2F; /* Rojo suave para saldo pendiente */
            }
    
            .date-range-filter {
                display: flex;
                gap: 16px;
                margin-bottom: 24px;
            }
    
            .date-range-filter input {
                width: 180px;
            }
    
            .financial-info p {
                font-size: 14px;
                margin: 8px 0;
                color: #37352F;
            }
    
            .financial-info h4 {
                font-size: 16px;
                margin-top: 24px;
                margin-bottom: 12px;
                color: #1A1A1A;
            }
            .grid-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 5px;
                margin-top: 20px;
            }
    
            .grid-item {
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-weight: bold;
                color: #2F3437; /* Texto oscuro legible en todos los fondos */
                border-radius: 4px;
                position: relative;
                cursor: pointer;
            }
    
            .grid-item:hover .tooltip {
                visibility: visible;
                opacity: 1;
            }
    
            .tooltip {
                visibility: hidden;
                width: 200px;
                background-color: #555;
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 5px;
                position: absolute;
                z-index: 1;
                bottom: 125%;
                left: 50%;
                margin-left: -100px;
                opacity: 0;
                transition: opacity 0.3s;
            }
    
            .legend {
                display: flex;
                gap: 20px;
                margin-top: 20px;
            }
    
            .legend-item {
                display: flex;
                align-items: center;
                gap: 5px;
            }
    
            .legend-color {
                width: 20px;
                height: 20px;
                border-radius: 4px;
            }
    
            #updateDate {
                margin-top: 10px;
                font-size: 18px;
                color: #787774;
            }
    
            .croquis-actions {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }
            .grid-container {
    display: grid;
    grid-template-columns: repeat(19, 50px);
    gap: 4px;
    justify-content: center;
    margin-right: 20px; /* Margen derecho para evitar que esté pegado */
    margin-left: 20px; /* Margen izquierdo para centrar simétricamente */
}
        </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container" id="setupScreen">
        <h1>Configuración Inicial</h1>
        <div class="form-group">
            <label for="totalLots">Número Total de Lotes:</label>
            <input type="number" id="totalLots" min="1" required>
        </div>
        <div class="form-group">
            <label>Vendedores:</label>
            <div id="sellerInputContainer"></div>
            <button onclick="addSellerInput()">Agregar Vendedor</button>
        </div>
        <button onclick="saveSetup()">Guardar y Continuar</button>
    </div>

    <div class="container" id="controlScreen" style="display: none;">
        <h2>Control de Lotes Vendidos</h2>
        <div class="form-box">
            <div class="form-group">
                <label for="lotId">Número de Lote(s) (separados por comas, ej. 1,2,3):</label>
                <input type="text" id="lotId" placeholder="Ingresa los lotes (ej. 1,2,3)" required oninput="checkLotStatus()">
            </div>
            <div id="lotStatusLabel"></div>
            <div id="fullForm">
                <div class="form-group">
                    <label for="seller">Vendedor:</label>
                    <select id="seller" required></select>
                </div>
                <div class="form-group">
                    <label for="buyerName">Nombre del Comprador:</label>
                    <input type="text" id="buyerName" required>
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Número de Teléfono:</label>
                    <input type="text" id="phoneNumber" placeholder="Ej. 50212345678" required>
                </div>
                <div class="form-group">
                    <label for="depositSlip">Número de Boleta de Depósito:</label>
                    <input type="text" id="depositSlip" required>
                </div>
                <div class="form-group">
                    <label for="receiptNumber">Número de Recibo:</label>
                    <input type="text" id="receiptNumber" required>
                </div>
                <div class="form-group">
                    <label for="saleDate">Fecha de Venta:</label>
                    <input type="date" id="saleDate" required>
                </div>
                <div class="form-group">
                    <label for="paymentType">Tipo de Pago:</label>
                    <select id="paymentType" required onchange="togglePaymentDetails()">
                        <option value="contado">Contado</option>
                        <option value="pagos">En Pagos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lotValue">Valor del Lote (Q.):</label>
                    <input type="text" id="lotValue" min="0" required oninput="formatInputNumber(this); updateTotalValue()">
                </div>
                <div class="form-group">
                    <label for="totalValue">Valor Total (Q.):</label>
                    <input type="text" id="totalValue" readonly>
                </div>
                <div class="form-group payment-details" id="amountPaidContainer">
                    <label for="amountPaid">Enganche Inicial Pagado (Q.):</label>
                    <input type="number" id="amountPaid" min="0" onchange="updateTotalValue()">
                </div>
                <div class="payment-details" id="paymentDetails">
                    <div class="form-group">
                        <label for="numPayments">Número de Pagos:</label>
                        <input type="number" id="numPayments" min="1" required>
                    </div>
                </div>
            </div>
            <button id="actionButton" onclick="handleAction()">Registrar Lote(s)</button>
            <div id="returnOption" style="display: none; margin-top: 20px;">
                <button class="return-button" onclick="processReturn()">Solicitar Devolución</button>
            </div>
            <div id="lotDetails">
                <h3>Detalles del Lote(s)</h3>
                <p><strong>Número de Lote(s):</strong> <span id="detailLotId"></span></p>
                <p><strong>Estado:</strong> <span id="detailStatus"></span></p>
                <p><strong>Vendedor:</strong> <span id="detailSeller"></span></p>
                <p><strong>Comprador:</strong> <span id="detailBuyer"></span></p>
                <p><strong>Teléfono:</strong> <span id="detailPhone"></span></p>
                <p><strong>Boleta de Depósito:</strong> <span id="detailDepositSlip"></span></p>
                <p><strong>Número de Recibo:</strong> <span id="detailReceipt"></span></p>
                <p><strong>Fecha de Venta:</strong> <span id="detailSaleDate"></span></p>
                <p><strong>Tipo de Pago:</strong> <span id="detailPaymentType"></span></p>
                <p><strong>Monto Pagado (Q.):</strong> <span id="detailTotalPaid"></span></p>
                <p><strong>Saldo Pendiente (Q.):</strong> <span id="detailBalance"></span></p>
                <p><strong>Pagos Realizados:</strong> <span id="detailPaymentsMade"></span></p>
                <p><strong>Pagos Pendientes:</strong> <span id="detailPaymentsPending"></span></p>
                <h4>Historial de Pagos</h4>
                <ul id="paymentHistory"></ul>
                <div class="form-group">
                    <label for="amountPaidPartial">Abono Parcial (Q.):</label>
                    <input type="number" id="amountPaidPartial" min="0">
                </div>
                <button id="addPartialPaymentButton" onclick="addPartialPayment()" style="margin-top: 10px;">Agregar Pago Parcial</button>
            </div>
        </div>

        <div class="counter">
            <p>Lotes Vendidos: <span id="soldCount">0</span></p>
            <p>Lotes Disponibles: <span id="availableCount">0</span></p>
            <p>Lotes en Crédito: <span id="creditCount">0</span></p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab('lots')">
                <i class="fas fa-home"></i> Lotes Registrados
            </button>
            <button class="tab-button" onclick="openTab('financial')">
                <i class="fas fa-chart-line"></i> Información Financiera
            </button>
            <button class="tab-button" onclick="openTab('croquis')">
                <i class="fas fa-map"></i> Croquis de Lotes
            </button>
        </div>
        <div id="croquis" class="tab-content">
            <h2>Croquis de Lotes</h2>
            <div class="croquis-actions">
                <button onclick="updateCroquis()">Actualizar Croquis</button>
                <button onclick="exportCroquis()">Descargar como Imagen</button>
            </div>
            <div id="gridContainer" class="grid-container"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #34C759;"></div> Disponible
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF3B30;"></div> Vendido
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF9500;"></div> En Crédito
                </div>
            </div>
            <p id="updateDate"></p>
        </div>

        <div id="lots" class="tab-content active">
            <div class="search-bar">
                <input type="text" id="searchLot" placeholder="Buscar por número de lote (ej. 1,2,3)..." oninput="renderLots(true)">
            </div>
            <h2>Lotes Registrados</h2>
            <div class="table-container">
                <table id="lotsTable">
                    <thead>
                        <tr>
                            <th>Número de Lote(s)</th>
                            <th>Estado</th>
                            <th>Vendedor</th>
                            <th>Comprador</th>
                            <th>Teléfono</th>
                            <th>Boleta de Depósito</th>
                            <th>Número de Recibo</th>
                            <th>Fecha de Venta</th>
                            <th>Fecha de Registro</th>
                            <th>Tipo de Pago</th>
                            <th>Monto Pagado (Q.)</th>
                            <th>Saldo Pendiente (Q.)</th>
                            <th>Monto Retenido (Q.)</th>
                        </tr>
                    </thead>
                    <tbody id="lotsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="financial-info">
            <h3>Información Financiera</h3>
            <div class="date-range-filter">
                <div class="form-group">
                    <label for="startDate">Fecha de Inicio:</label>
                    <input type="date" id="startDate" oninput="updateFinancialInfo()">
                </div>
                <div class="form-group">
                    <label for="endDate">Fecha de Fin:</label>
                    <input type="date" id="endDate" oninput="updateFinancialInfo()">
                </div>
            </div>
            <p>Total Acumulado (Q.): <span id="totalAccumulated">0.00</span></p>
            <p>Saldo Pendiente Total (Q.): <span id="totalPending">0.00</span></p>
            <p>Total Devuelto (Q.): <span id="totalRefunded">0.00</span></p>
            <p>Total Retenido (Q.): <span id="totalRetained">0.00</span></p>
            <p>Total de Comisiones (Q.): <span id="totalSalesCommissions">0.00</span></p>
            <p>Total de Comisiones por Devolución (Q.): <span id="totalReturnCommissions">0.00</span></p>
            <p>Ingresos Netos (Q.): <span id="netIncome">0.00</span></p>
            <div class="sales-by-seller">
                <h4>Ventas por Vendedor</h4>
                <table id="salesBySellerTable">
                    <thead>
                        <tr>
                            <th>Vendedor</th>
                            <th>Número de Lotes Vendidos</th>
                            <th>Monto Total Pagado (Q.)</th>
                            <th>Comisiones (Q.)</th>
                            <th>Comisión por Devoluciones (Q.)</th>
                        </tr>
                    </thead>
                    <tbody id="salesBySellerTableBody"></tbody>
                </table>
            </div>
            <div class="sales-by-payment-type">
                <h4>Ventas por Tipo de Pago</h4>
                <table id="salesByPaymentTypeTable">
                    <thead>
                        <tr>
                            <th>Tipo de Pago</th>
                            <th>Número de Lotes</th>
                        </tr>
                    </thead>
                    <tbody id="salesByPaymentTypeTableBody"></tbody>
                </table>
                <h4>Devoluciones</h4>
                <table id="returnsTable">
                    <thead>
                        <tr>
                            <th>Devoluciones</th>
                            <th>Número de Lotes</th>
                        </tr>
                    </thead>
                    <tbody id="returnsTableBody">
                        <tr>
                            <td>Devoluciones</td>
                            <td id="returnCount">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="button-group">
            <button class="reset-button" onclick="resetSetup()">Reiniciar Configuración</button>
            <button class="export-button" onclick="exportToExcel()">Exportar a Excel</button>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">×</span>
                <h2>Lote Ya Vendido</h2>
                <p><strong>Vendedor:</strong> <span id="modalSeller"></span></p>
                <p><strong>Comprador:</strong> <span id="modalBuyer"></span></p>
                <p><strong>Fecha de Venta:</strong> <span id="modalSaleDate"></span></p>
                <p><strong>Boleta de Depósito:</strong> <span id="modalDepositSlip"></span></p>
                <p><strong>Número de Recibo:</strong> <span id="modalReceiptNumber"></span></p>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_LOT_PRICE = 15000;
        let totalLots = parseInt(localStorage.getItem('totalLots')) || 0;
        let sellers = JSON.parse(localStorage.getItem('sellers')) || [];
        let lots = JSON.parse(localStorage.getItem('lots')) || [];
        let lotGroups = JSON.parse(localStorage.getItem('lotGroups')) || [];
        let lotHistory = JSON.parse(localStorage.getItem('lotHistory')) || [];
        let sellerInputs = [];
        let currentLotGroup = null;
        let entryCounter = parseInt(localStorage.getItem('entryCounter')) || 0;

        // Initialize arrays if they're not properly set
        lots = Array.isArray(lots) ? lots : [];
        lotGroups = Array.isArray(lotGroups) ? lotGroups : [];
        lotHistory = Array.isArray(lotHistory) ? lotHistory : [];

        // Update statuses for existing lots and groups
        lots = lots.map(lot => ({
            ...lot,
            status: lot.paymentType === 'pagos' && !['vendido', 'disponible', 'devuelto'].includes(lot.status) ? 'crédito' : lot.status
        }));
        lotGroups = lotGroups.map(group => ({
            ...group,
            status: group.paymentType === 'pagos' && !['vendido', 'disponible', 'devuelto'].includes(group.status) ? 'crédito' : group.status
        }));

        // Utility functions
        const formatNumber = number => number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const formatInputNumber = input => {
            let value = input.value.replace(/,/g, '');
            if (value) input.value = formatNumber(value);
            updateTotalValue();
        };
        const parseFormattedNumber = value => parseFloat(value.replace(/,/g, '')) || 0;
        const generateEntryId = () => {
            entryCounter++;
            localStorage.setItem('entryCounter', entryCounter);
            return entryCounter;
        };
        const saveToStorage = () => {
            localStorage.setItem('lots', JSON.stringify(lots));
            localStorage.setItem('lotGroups', JSON.stringify(lotGroups));
            localStorage.setItem('lotHistory', JSON.stringify(lotHistory));
        };

        // Setup screen functions
        function addSellerInput() {
            const container = document.getElementById('sellerInputContainer');
            const index = sellerInputs.length;
            const div = document.createElement('div');
            div.className = 'seller-input';
            div.innerHTML = `
                <input type="text" id="sellerInput${index}" placeholder="Nombre del vendedor" required>
                <button class="remove-seller" onclick="removeSellerInput(${index})">Eliminar</button>
            `;
            container.appendChild(div);
            sellerInputs.push(div);
        }

        function removeSellerInput(index) {
            const container = document.getElementById('sellerInputContainer');
            container.removeChild(sellerInputs[index]);
            sellerInputs.splice(index, 1);
            sellerInputs.forEach((div, i) => {
                div.querySelector('button').setAttribute('onclick', `removeSellerInput(${i})`);
            });
        }

        function saveSetup() {
            const totalLotsInput = document.getElementById('totalLots').value;
            const sellerInputsValues = sellerInputs.map((_, i) => document.getElementById(`sellerInput${i}`).value.trim()).filter(value => value);

            if (!totalLotsInput || !sellerInputsValues.length) {
                alert('Por favor, ingresa el número total de lotes y al menos un vendedor.');
                return;
            }

            totalLots = parseInt(totalLotsInput);
            sellers = sellerInputsValues;
            localStorage.setItem('totalLots', totalLots);
            localStorage.setItem('sellers', JSON.stringify(sellers));

            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('controlScreen').style.display = 'block';
            initializeControlScreen();
        }

        function resetSetup() {
    if (confirm('¿Estás seguro de reiniciar la configuración? Esto eliminará todos los datos.')) {
        localStorage.clear();
        totalLots = 0;
        sellers = [];
        lots = [];
        lotGroups = [];
        lotHistory = [];
        sellerInputs = [];
        entryCounter = 0;
        document.getElementById('controlScreen').style.display = 'none';
        document.getElementById('setupScreen').style.display = 'block';
        document.getElementById('totalLots').value = '';
        document.getElementById('sellerInputContainer').innerHTML = '';
        document.getElementById('lotsTableBody').innerHTML = '';
        document.getElementById('soldCount').textContent = '0';
        document.getElementById('availableCount').textContent = '0';
        document.getElementById('creditCount').textContent = '0';
        clearForm();
        updateFinancialInfo();
    }
}

        function initializeControlScreen() {
    document.getElementById('lotId').setAttribute('max', totalLots);
    const sellerSelect = document.getElementById('seller');
    sellerSelect.innerHTML = sellers.map(seller => `<option value="${seller}">${seller}</option>`).join('');
    document.getElementById('lotValue').value = formatNumber(DEFAULT_LOT_PRICE);
    renderLots();
    updateFinancialInfo();
    togglePaymentDetails();
    updateTotalValue();
    openTab('lots');
    updateCroquis(); // Asegúrate de que esta línea esté presente
}

        // Tab navigation
        function openTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Form handling
        function checkLotStatus() {
    const lotIdInput = document.getElementById('lotId').value;
    const lotIds = lotIdInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
    const actionButton = document.getElementById('actionButton');
    const fullForm = document.getElementById('fullForm');
    const lotDetails = document.getElementById('lotDetails');
    const lotStatusLabel = document.getElementById('lotStatusLabel');
    const returnOption = document.getElementById('returnOption');

    // Resetear estados iniciales
    fullForm.style.display = 'block';
    lotDetails.style.display = 'none';
    lotStatusLabel.style.display = 'none';
    actionButton.style.display = 'block';
    actionButton.textContent = 'Registrar Lote(s)';
    returnOption.style.display = 'none';

    if (!lotIds.length) {
        clearForm();
        return;
    }

    // Validación para asegurarse de que los lotes no excedan totalLots
    const invalidIds = lotIds.filter(id => id > totalLots);
    if (invalidIds.length > 0) {
        alert(`Los lotes con números ${invalidIds.join(', ')} exceden la cantidad total de lotes disponibles (${totalLots}).`);
        document.getElementById('lotId').value = '';
        clearForm();
        return;
    }

    const unavailableLots = lotIds.filter(lotId => {
        const lot = lots.find(l => l.id === lotId);
        return lot && (lot.status === 'vendido' || lot.status === 'crédito');
    });

    if (unavailableLots.length > 0) {
        const firstUnavailableLot = lots.find(l => l.id === unavailableLots[0]);
        let entity;
        let isGroup = !!firstUnavailableLot.groupId;
        let statusText = '';

        if (isGroup) {
            entity = lotGroups.find(g => g.groupId === firstUnavailableLot.groupId);
            if (entity) {
                statusText = entity.status === 'vendido' && entity.balance === 0 
                    ? `Vendido - Comprador: ${entity.buyerName}, Vendedor: ${entity.seller}, Boleta: ${entity.depositSlip}` 
                    : 'En Pagos';
            }
        } else {
            entity = firstUnavailableLot;
            statusText = firstUnavailableLot.status === 'vendido' && firstUnavailableLot.balance === 0 
                ? `Vendido - Comprador: ${firstUnavailableLot.buyerName}, Vendedor: ${firstUnavailableLot.seller}, Boleta: ${firstUnavailableLot.depositSlip}` 
                : 'En Pagos';
        }

        if (entity.status === 'vendido' && entity.balance === 0) {
            lotStatusLabel.textContent = statusText;
            lotStatusLabel.className = 'status-vendido';
            lotStatusLabel.style.display = 'block';
            fullForm.style.display = 'none';
            actionButton.style.display = 'none';

            currentLotGroup = isGroup ? entity : [firstUnavailableLot];
            lotDetails.style.display = 'block';
            displayLotDetails(currentLotGroup, isGroup);
            returnOption.style.display = 'none';
        } else if (entity.status === 'crédito') {
            lotStatusLabel.textContent = statusText;
            lotStatusLabel.className = 'status-en-pagos';
            lotStatusLabel.style.display = 'block';
            fullForm.style.display = 'none';
            actionButton.style.display = 'none';

            currentLotGroup = isGroup ? entity : [firstUnavailableLot];
            lotDetails.style.display = 'block';
            displayLotDetails(currentLotGroup, isGroup);
            returnOption.style.display = entity.balance > 0 ? 'block' : 'none';
        }
        updateTotalValue();
        return;
    }

    lotStatusLabel.textContent = 'Disponible';
    lotStatusLabel.className = 'status-disponible';
    lotStatusLabel.style.display = 'block';
    updateTotalValue();
}

        function displayLotDetails(entity, isGroup) {
            const { lotIds, status, seller, buyerName, phoneNumber, depositSlip, receiptNumber, saleDate, paymentType, totalPaid, balance, payments, numPayments } = isGroup
                ? {
                    lotIds: entity.lotIds.join(', '),
                    status: entity.status,
                    seller: entity.seller,
                    buyerName: entity.buyerName,
                    phoneNumber: entity.phoneNumber,
                    depositSlip: entity.depositSlip,
                    receiptNumber: entity.receiptNumber,
                    saleDate: entity.saleDate,
                    paymentType: entity.paymentType,
                    totalPaid: entity.totalPaid,
                    balance: entity.balance,
                    payments: entity.payments,
                    numPayments: entity.numPayments
                }
                : {
                    lotIds: entity[0].id,
                    status: entity[0].status,
                    seller: entity[0].seller,
                    buyerName: entity[0].buyerName,
                    phoneNumber: entity[0].phoneNumber,
                    depositSlip: entity[0].depositSlip,
                    receiptNumber: entity[0].receiptNumber,
                    saleDate: entity[0].saleDate,
                    paymentType: entity[0].paymentType,
                    totalPaid: entity[0].totalPaid,
                    balance: entity[0].balance,
                    payments: entity[0].payments,
                    numPayments: entity[0].numPayments
                };

            const lotDetails = document.getElementById('lotDetails');
            lotDetails.style.display = 'block';
            document.getElementById('detailLotId').textContent = lotIds;
            document.getElementById('detailStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
            document.getElementById('detailSeller').textContent = seller;
            document.getElementById('detailBuyer').textContent = buyerName;
            document.getElementById('detailPhone').textContent = phoneNumber;
            document.getElementById('detailDepositSlip').textContent = depositSlip;
            document.getElementById('detailReceipt').textContent = receiptNumber;
            document.getElementById('detailSaleDate').textContent = saleDate;
            document.getElementById('detailPaymentType').textContent = paymentType.charAt(0).toUpperCase() + paymentType.slice(1);
            document.getElementById('detailTotalPaid').textContent = formatNumber(totalPaid.toFixed(2));
            document.getElementById('detailBalance').textContent = formatNumber(balance.toFixed(2));
            document.getElementById('detailPaymentsMade').textContent = payments.length;
            document.getElementById('detailPaymentsPending').textContent = numPayments - payments.length;
            document.getElementById('paymentHistory').innerHTML = payments.map(p => `<li>Pago de Q. ${formatNumber(p.amount.toFixed(2))} el ${p.date}</li>`).join('');
            document.getElementById('amountPaidPartial').value = '';

            const addPartialPaymentButton = document.getElementById('addPartialPaymentButton');
            addPartialPaymentButton.disabled = balance === 0;
            addPartialPaymentButton.style.opacity = balance === 0 ? 0.5 : 1;
            addPartialPaymentButton.style.cursor = balance === 0 ? 'not-allowed' : 'pointer';
        }

        function togglePaymentDetails() {
            const paymentType = document.getElementById('paymentType').value;
            const paymentDetails = document.getElementById('paymentDetails');
            const amountPaidContainer = document.getElementById('amountPaidContainer');
            paymentDetails.style.display = paymentType === 'pagos' ? 'block' : 'none';
            amountPaidContainer.style.display = paymentType === 'pagos' ? 'block' : 'none';
            if (paymentType !== 'pagos') document.getElementById('numPayments').value = '';
            updateTotalValue();
        }

        function updateTotalValue() {
            const lotIdInput = document.getElementById('lotId').value;
            const lotIds = lotIdInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            const lotValueInput = document.getElementById('lotValue').value;
            const lotValue = parseFormattedNumber(lotValueInput) || DEFAULT_LOT_PRICE;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const totalValueInput = document.getElementById('totalValue');

            const availableLots = lotIds.filter(lotId => {
                const lot = lots.find(l => l.id === lotId);
                return !lot || lot.status === 'devuelto';
            });

            if (availableLots.length > 0) {
                const totalValue = lotValue * availableLots.length;
                totalValueInput.value = formatNumber(totalValue.toFixed(2));
                if (amountPaid > totalValue) {
                    alert(`El enganche inicial (Q. ${formatNumber(amountPaid.toFixed(2))}) no puede exceder el valor total (Q. ${formatNumber(totalValue.toFixed(2))}).`);
                    document.getElementById('amountPaid').value = '';
                }
            } else {
                totalValueInput.value = '0.00';
            }
        }

        function handleAction() {
            const lotIdInput = document.getElementById('lotId').value;
            const lotIds = lotIdInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id) && id > 0 && id <= totalLots);
            if (!lotIds.length) {
                alert('Por favor, ingresa al menos un número de lote válido.');
                return;
            }

            const formData = {
                seller: document.getElementById('seller').value,
                buyerName: document.getElementById('buyerName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                depositSlip: document.getElementById('depositSlip').value,
                receiptNumber: document.getElementById('receiptNumber').value,
                saleDate: document.getElementById('saleDate').value,
                paymentType: document.getElementById('paymentType').value,
                lotValue: parseFormattedNumber(document.getElementById('lotValue').value) || DEFAULT_LOT_PRICE,
                amountPaid: document.getElementById('paymentType').value === 'pagos' ? (parseFloat(document.getElementById('amountPaid').value) || 0) : null,
                numPayments: document.getElementById('paymentType').value === 'pagos' ? (parseInt(document.getElementById('numPayments').value) || 1) : 1
            };

            const totalValue = formData.lotValue * lotIds.length;
            formData.amountPaid = formData.paymentType === 'pagos' ? formData.amountPaid : totalValue;

            if (!formData.seller || !formData.buyerName || !formData.phoneNumber || !formData.depositSlip || !formData.receiptNumber || !formData.saleDate || (formData.paymentType === 'pagos' && !formData.amountPaid) || formData.lotValue <= 0) {
                alert('Por favor, completa todos los campos requeridos y asegúrate de que el valor del lote sea mayor que 0.');
                return;
            }

            const availableLots = lotIds.filter(lotId => {
                const lot = lots.find(l => l.id === lotId);
                return !lot || lot.status === 'devuelto';
            });

            if (availableLots.length !== lotIds.length) {
                alert('Uno o más lotes no están disponibles para registro.');
                return;
            }

            if (formData.amountPaid > totalValue) {
                alert(`El enganche inicial (Q. ${formatNumber(formData.amountPaid.toFixed(2))}) no puede exceder el valor total (Q. ${formatNumber(totalValue.toFixed(2))}).`);
                return;
            }

            const entryId = generateEntryId();
            const balance = totalValue - formData.amountPaid;
            const status = formData.paymentType === 'pagos' ? (balance === 0 ? 'vendido' : 'crédito') : 'vendido';

            if (lotIds.length === 1) {
                const lot = {
                    entryId: entryId,
                    id: lotIds[0],
                    status: status,
                    ...formData,
                    entryDate: new Date().toISOString().slice(0, 10),
                    payments: formData.paymentType === 'pagos' ? [{ amount: formData.amountPaid, date: new Date().toISOString().slice(0, 10) }] : [],
                    totalPaid: formData.amountPaid,
                    balance: balance,
                    retainedAmount: 0,
                    totalValue: totalValue
                };

                const existingLot = lots.find(l => l.id === lotIds[0]);
                if (existingLot) {
                    lots[lots.indexOf(existingLot)] = lot;
                } else {
                    lots.push(lot);
                }
                lotHistory.push(lot);
            } else {
                const group = {
                    groupId: entryId,
                    lotIds: lotIds,
                    status: status,
                    ...formData,
                    entryDate: new Date().toISOString().slice(0, 10),
                    payments: formData.paymentType === 'pagos' ? [{ amount: formData.amountPaid, date: new Date().toISOString().slice(0, 10) }] : [],
                    totalPaid: formData.amountPaid,
                    balance: balance,
                    retainedAmount: 0,
                    totalValue: totalValue
                };

                lotGroups.push(group);

                lotIds.forEach(lotId => {
                    const existingLot = lots.find(l => l.id === lotId);
                    const lot = {
                        id: lotId,
                        status: status,
                        ...formData,
                        entryDate: new Date().toISOString().slice(0, 10),
                        groupId: entryId
                    };

                    if (existingLot) {
                        lots[lots.indexOf(existingLot)] = lot;
                    } else {
                        lots.push(lot);
                    }
                    lotHistory.push(lot);
                });
            }

            saveToStorage();
            renderLots();
            updateFinancialInfo();
            clearForm();
        }

        function addPartialPayment() {
            const lotIdInput = document.getElementById('lotId').value;
            const lotIds = lotIdInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            const partialPayment = parseFloat(document.getElementById('amountPaidPartial').value) || 0;

            if (!lotIds.length || !partialPayment) {
                alert('Por favor, ingresa un monto válido para el pago parcial.');
                return;
            }

            let entity = currentLotGroup;
            let isGroup = !Array.isArray(entity);

            if (isGroup) {
                if (entity.balance <= 0) {
                    alert('El grupo de lotes ya está completamente pagado.');
                    return;
                }

                if (partialPayment > entity.balance) {
                    alert(`El pago parcial (Q. ${formatNumber(partialPayment.toFixed(2))}) no puede exceder el saldo pendiente (Q. ${formatNumber(entity.balance.toFixed(2))}).`);
                    document.getElementById('amountPaidPartial').value = '';
                    return;
                }

                entity.payments.push({ amount: partialPayment, date: new Date().toISOString().slice(0, 10) });
                entity.totalPaid += partialPayment;
                entity.balance -= partialPayment;
                entity.status = entity.balance === 0 ? 'vendido' : 'crédito';

                lots = lots.map(lot => entity.lotIds.includes(lot.id) ? { ...lot, status: entity.status } : lot);
                saveToStorage();
            } else {
                entity = lots.filter(lot => lotIds.includes(lot.id));
                if (!entity.length) {
                    alert('Este lote no está registrado.');
                    return;
                }

                const totalBalance = entity.reduce((sum, lot) => sum + lot.balance, 0);
                if (totalBalance <= 0) {
                    alert('El lote ya está completamente pagado.');
                    return;
                }

                if (partialPayment > totalBalance) {
                    alert(`El pago parcial (Q. ${formatNumber(partialPayment.toFixed(2))}) no puede exceder el saldo pendiente (Q. ${formatNumber(totalBalance.toFixed(2))}).`);
                    document.getElementById('amountPaidPartial').value = '';
                    return;
                }

                const perLotPayment = partialPayment / entity.length;
                entity.forEach(lot => {
                    lot.payments.push({ amount: perLotPayment, date: new Date().toISOString().slice(0, 10) });
                    lot.totalPaid += perLotPayment;
                    lot.balance = lot.lotValue - lot.totalPaid;
                    lot.status = lot.balance === 0 ? 'vendido' : 'crédito';
                });
                saveToStorage();
            }

            renderLots();
            updateFinancialInfo();
            displayLotDetails(entity, isGroup);
            document.getElementById('returnOption').style.display = (isGroup ? entity.balance : entity.some(lot => lot.balance > 0)) > 0 ? 'block' : 'none';
        }

        function processReturn() {
            if (!currentLotGroup) {
                alert('No se ha seleccionado un lote o grupo de lotes válido para procesar la devolución.');
                return;
            }

            const lotIdInput = document.getElementById('lotId').value;
            const lotIds = lotIdInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            const isGroup = !Array.isArray(currentLotGroup);
            let entity = currentLotGroup;

            if (isGroup) {
                if (!entity.lotIds.every(id => lotIds.includes(id)) || lotIds.length !== entity.lotIds.length) {
                    alert('Por favor, selecciona el grupo completo para procesar la devolución.');
                    return;
                }

                if (entity.paymentType !== 'pagos' || entity.status === 'vendido') {
                    alert('Este grupo de lotes no es elegible para devolución. Debe estar en estado "crédito".');
                    return;
                }

                const totalPaid = entity.totalPaid;
                const retention = totalPaid * 0.25;
                const refund = totalPaid - retention;
                const commission = retention * 0.10; // 10% del monto retenido

                if (confirm(`Se retendrá el 25% (Q. ${formatNumber(retention.toFixed(2))}) y se devolverá Q. ${formatNumber(refund.toFixed(2))}. ¿Deseas proceder?`)) {
                    entity.status = 'devuelto';
                    entity.retainedAmount = retention;
                    entity.refundAmount = refund;
                    entity.sellerCommission = commission;
                    entity.totalPaid = 0;
                    entity.balance = entity.totalValue;
                    entity.payments = [];

                    lots = lots.map(lot => entity.lotIds.includes(lot.id) ? {
                        ...lot,
                        status: 'devuelto',
                        totalPaid: 0,
                        balance: lot.lotValue,
                        payments: [],
                        retainedAmount: retention / entity.lotIds.length,
                        refundAmount: refund / entity.lotIds.length,
                        sellerCommission: commission / entity.lotIds.length
                    } : lot);

                    entity.lotIds.forEach(lotId => {
                        const lot = lots.find(l => l.id === lotId);
                        lotHistory.push({ ...lot, entryDate: new Date().toISOString().slice(0, 10) });
                    });

                    saveToStorage();
                    renderLots();
                    updateFinancialInfo();
                    alert(`Devolución procesada. Retención: Q. ${formatNumber(retention.toFixed(2))}, Reembolso: Q. ${formatNumber(refund.toFixed(2))}. Los lotes ahora están disponibles para una nueva venta.`);
                    clearForm();
                }
            } else {
                if (lotIds.length !== 1) {
                    alert('Por favor, selecciona un solo lote para procesar la devolución.');
                    return;
                }

                const lot = currentLotGroup[0];
                if (!lot || lot.paymentType !== 'pagos' || lot.status === 'vendido') {
                    alert('Este lote no es elegible para devolución. Debe estar en estado "crédito".');
                    return;
                }

                const totalPaid = lot.totalPaid;
                const retention = totalPaid * 0.25;
                const refund = totalPaid - retention;
                const commission = retention * 0.10; // 10% del monto retenido

                if (confirm(`Se retendrá el 25% (Q. ${formatNumber(retention.toFixed(2))}) y se devolverá Q. ${formatNumber(refund.toFixed(2))}. ¿Deseas proceder?`)) {
                    const devolvedLot = {
                        ...lot,
                        status: 'devuelto',
                        entryDate: new Date().toISOString().slice(0, 10),
                        payments: [],
                        totalPaid: 0,
                        balance: lot.lotValue,
                        retainedAmount: retention,
                        refundAmount: refund,
                        sellerCommission: commission
                    };

                    lots[lots.indexOf(lot)] = devolvedLot;
                    lotHistory.push(devolvedLot);

                    saveToStorage();
                    renderLots();
                    updateFinancialInfo();
                    alert(`Devolución procesada. Retención: Q. ${formatNumber(retention.toFixed(2))}, Reembolso: Q. ${formatNumber(refund.toFixed(2))}. El lote ahora está disponible para una nueva venta.`);
                    clearForm();
                }
            }
        }

        function renderLots(isSearch = false) {
    const searchValue = isSearch ? document.getElementById('searchLot').value.trim() : '';
    const searchIds = searchValue.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id) && id > 0);
    const dataToRender = isSearch && searchValue ? lotHistory.filter(lot => searchIds.includes(lot.id)) : lotHistory;

    if (isSearch && searchValue) {
        // Validación para asegurarse de que los lotes no excedan totalLots
        const invalidIds = searchIds.filter(id => id > totalLots);
        if (invalidIds.length > 0) {
            alert(`Los lotes con números ${invalidIds.join(', ')} exceden la cantidad total de lotes disponibles (${totalLots}).`);
            document.getElementById('searchLot').value = '';
            document.getElementById('lotStatusLabel').style.display = 'none'; // Ocultar la etiqueta al invalidar
            return;
        }

        const lotsToCheck = lots.filter(lot => searchIds.includes(lot.id));
        const unavailableLots = lotsToCheck.filter(lot => lot.status === 'vendido' || lot.status === 'crédito');

        if (unavailableLots.length > 0) {
            const firstUnavailableLot = unavailableLots[0];
            let entity;
            let isGroup = !!firstUnavailableLot.groupId;
            let statusText = '';

            if (isGroup) {
                entity = lotGroups.find(g => g.groupId === firstUnavailableLot.groupId);
                if (entity) {
                    statusText = entity.status === 'vendido' && entity.balance === 0 
                        ? `Vendido - Comprador: ${entity.buyerName}, Vendedor: ${entity.seller}, Boleta: ${entity.depositSlip}` 
                        : 'En Pagos';
                }
            } else {
                entity = firstUnavailableLot;
                statusText = firstUnavailableLot.status === 'vendido' && firstUnavailableLot.balance === 0 
                    ? `Vendido - Comprador: ${firstUnavailableLot.buyerName}, Vendedor: ${firstUnavailableLot.seller}, Boleta: ${firstUnavailableLot.depositSlip}` 
                    : 'En Pagos';
            }

            if (entity.status === 'vendido' && entity.balance === 0) {
                document.getElementById('lotId').value = searchValue;
                document.getElementById('lotStatusLabel').textContent = statusText;
                document.getElementById('lotStatusLabel').className = 'status-vendido';
                document.getElementById('lotStatusLabel').style.display = 'block';
                document.getElementById('fullForm').style.display = 'none';
                document.getElementById('actionButton').style.display = 'none';

                currentLotGroup = isGroup ? entity : [firstUnavailableLot];
                document.getElementById('lotDetails').style.display = 'block';
                displayLotDetails(currentLotGroup, isGroup);
                document.getElementById('returnOption').style.display = 'none';
            } else if (entity.status === 'crédito') {
                document.getElementById('lotId').value = searchValue;
                document.getElementById('lotStatusLabel').textContent = statusText;
                document.getElementById('lotStatusLabel').className = 'status-en-pagos';
                document.getElementById('lotStatusLabel').style.display = 'block';
                document.getElementById('fullForm').style.display = 'none';
                document.getElementById('actionButton').style.display = 'none';

                currentLotGroup = isGroup ? entity : [firstUnavailableLot];
                document.getElementById('lotDetails').style.display = 'block';
                displayLotDetails(currentLotGroup, isGroup);
                document.getElementById('returnOption').style.display = entity.balance > 0 ? 'block' : 'none';
            } else {
                clearForm();
            }
        } else {
            document.getElementById('lotId').value = searchValue;
            document.getElementById('lotStatusLabel').textContent = 'Disponible';
            document.getElementById('lotStatusLabel').className = 'status-disponible';
            document.getElementById('lotStatusLabel').style.display = 'block';
            document.getElementById('fullForm').style.display = 'block';
            document.getElementById('actionButton').style.display = 'block';
            document.getElementById('lotDetails').style.display = 'none';
            document.getElementById('returnOption').style.display = 'none';
        }
    } else {
        clearForm();
        document.getElementById('lotStatusLabel').style.display = 'none'; // Ocultar la etiqueta cuando no hay búsqueda
    }

    const groupedLots = {};
    dataToRender.forEach(lot => {
        const key = lot.groupId ? lot.groupId : `single_${lot.id}`;
        if (!groupedLots[key]) {
            if (lot.groupId) {
                const group = lotGroups.find(g => g.groupId === lot.groupId);
                groupedLots[key] = {
                    lotIds: group.lotIds,
                    status: group.status,
                    seller: group.seller,
                    buyerName: group.buyerName,
                    phoneNumber: group.phoneNumber,
                    depositSlip: group.depositSlip,
                    receiptNumber: group.receiptNumber,
                    saleDate: group.saleDate,
                    entryDate: group.entryDate,
                    paymentType: group.paymentType,
                    totalPaid: group.totalPaid || 0,
                    balance: group.balance || 0,
                    retainedAmount: group.retainedAmount || 0
                };
            } else {
                groupedLots[key] = {
                    lotIds: [lot.id],
                    status: lot.status,
                    seller: lot.seller,
                    buyerName: lot.buyerName,
                    phoneNumber: lot.phoneNumber,
                    depositSlip: lot.depositSlip,
                    receiptNumber: lot.receiptNumber,
                    saleDate: lot.saleDate,
                    entryDate: lot.entryDate,
                    paymentType: lot.paymentType,
                    totalPaid: lot.totalPaid || 0,
                    balance: lot.balance || 0,
                    retainedAmount: lot.retainedAmount || 0
                };
            }
        }
    });

    const tableBody = document.getElementById('lotsTableBody');
    tableBody.innerHTML = '';
    Object.values(groupedLots).forEach(group => {
        const row = document.createElement('tr');
        const isDevuelto = group.status === 'devuelto';
        const textClass = isDevuelto ? 'status-devuelto-text' : '';
        row.innerHTML = `
            <td class="${textClass}">${group.lotIds.join(', ')}</td>
            <td class="${textClass}">${(group.status || '').charAt(0).toUpperCase() + (group.status || '').slice(1)}</td>
            <td class="${textClass}">${group.seller || ''}</td>
            <td class="${textClass}">${group.buyerName || ''}</td>
            <td class="${textClass}">${group.phoneNumber || ''}</td>
            <td class="${textClass}">${group.depositSlip || ''}</td>
            <td class="${textClass}">${group.receiptNumber || ''}</td>
            <td class="${textClass}">${group.saleDate || ''}</td>
            <td class="${textClass}">${group.entryDate || ''}</td>
            <td class="${textClass}">${(group.paymentType || '').charAt(0).toUpperCase() + (group.paymentType || '').slice(1)}</td>
            <td class="${textClass}">${formatNumber(group.totalPaid.toFixed(2))}</td>
            <td class="${textClass}">${formatNumber(group.balance.toFixed(2))}</td>
            <td class="${textClass}">${formatNumber(group.retainedAmount.toFixed(2))}</td>
        `;
        row.addEventListener('click', () => {
            tableBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
        });
        tableBody.appendChild(row);
    });

    const soldCount = lots.filter(lot => lot.status === 'vendido').length;
    const creditCount = lots.filter(lot => lot.status === 'crédito').length;
    document.getElementById('soldCount').textContent = soldCount;
    document.getElementById('availableCount').textContent = totalLots - (soldCount + creditCount);
    document.getElementById('creditCount').textContent = creditCount;
}

function updateFinancialInfo() {
    const startDateInput = document.getElementById('startDate').value;
    const endDateInput = document.getElementById('endDate').value;
    const startDate = startDateInput ? new Date(startDateInput) : null;
    const endDate = endDateInput ? new Date(endDateInput) : null;

    let filteredLots = lots;
    let filteredGroups = lotGroups;
    let filteredReturnedLots = lots.filter(lot => lot.status === 'devuelto');
    let filteredReturnedGroups = lotGroups.filter(group => group.status === 'devuelto');

    if (startDate || endDate) {
        filteredLots = lots.filter(lot => {
            const saleDate = new Date(lot.saleDate);
            if (startDate && saleDate < startDate) return false;
            if (endDate) {
                const adjustedEndDate = new Date(endDate);
                adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
                if (saleDate >= adjustedEndDate) return false;
            }
            return true;
        });

        filteredGroups = lotGroups.filter(group => {
            const saleDate = new Date(group.saleDate);
            if (startDate && saleDate < startDate) return false;
            if (endDate) {
                const adjustedEndDate = new Date(endDate);
                adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
                if (saleDate >= adjustedEndDate) return false;
            }
            return true;
        });

        filteredReturnedLots = filteredLots.filter(lot => lot.status === 'devuelto');
        filteredReturnedGroups = filteredGroups.filter(group => group.status === 'devuelto');
    }

    const activeLots = filteredLots.filter(lot => lot.status !== 'devuelto');
    const returnedLots = filteredReturnedLots;
    const activeGroups = filteredGroups.filter(group => group.status !== 'devuelto');
    const returnedGroups = filteredReturnedGroups;

    // Total acumulado: pagos recibidos de lotes activos (contado y crédito)
    const totalAccumulated = activeLots.filter(lot => !lot.groupId).reduce((sum, lot) => sum + (lot.totalPaid || 0), 0) +
                             activeGroups.reduce((sum, group) => sum + (group.totalPaid || 0), 0);

    const totalPending = activeLots.filter(lot => lot.status === 'crédito' && !lot.groupId).reduce((sum, lot) => sum + (lot.balance || 0), 0) +
                         activeGroups.filter(group => group.status === 'crédito').reduce((sum, group) => sum + (group.balance || 0), 0);

    const totalRefunded = returnedLots.filter(lot => !lot.groupId).reduce((sum, lot) => sum + (lot.refundAmount || 0), 0) +
                          returnedGroups.reduce((sum, group) => sum + (group.refundAmount || 0), 0);

    const totalRetained = returnedLots.filter(lot => !lot.groupId).reduce((sum, lot) => sum + (lot.retainedAmount || 0), 0) +
                          returnedGroups.reduce((sum, group) => sum + (group.retainedAmount || 0), 0);

    // Total de comisiones por ventas: 10% de todos los ingresos (contado y crédito)
    const totalSalesCommissions = totalAccumulated * 0.10;

    // Total de comisiones por devolución: 10% del monto retenido
    const totalReturnCommissions = returnedLots.filter(lot => !lot.groupId).reduce((sum, lot) => sum + (lot.sellerCommission || 0), 0) +
                                   returnedGroups.reduce((sum, group) => sum + (group.sellerCommission || 0), 0);

    // Ingresos netos: Total acumulado + Total retenido - Total de comisiones por ventas - Total de comisiones por devolución
    const netIncome = totalAccumulated + totalRetained - totalSalesCommissions - totalReturnCommissions;

    // Actualizar los valores en el HTML
    document.getElementById('totalAccumulated').textContent = formatNumber(totalAccumulated.toFixed(2));
    document.getElementById('totalPending').textContent = formatNumber(totalPending.toFixed(2));
    document.getElementById('totalRefunded').textContent = formatNumber(totalRefunded.toFixed(2));
    document.getElementById('totalRetained').textContent = formatNumber(totalRetained.toFixed(2));
    document.getElementById('totalSalesCommissions').textContent = formatNumber(totalSalesCommissions.toFixed(2));
    document.getElementById('totalReturnCommissions').textContent = formatNumber(totalReturnCommissions.toFixed(2));
    document.getElementById('netIncome').textContent = formatNumber(netIncome.toFixed(2));

    // Actualizar tabla de ventas por vendedor
    const salesBySeller = {};
    sellers.forEach(seller => {
        salesBySeller[seller] = { count: 0, totalPaid: 0, salesCommission: 0, returnCommission: 0 };
    });

    activeLots.forEach(lot => {
        if (!lot.groupId) {
            salesBySeller[lot.seller].count += 1;
            salesBySeller[lot.seller].totalPaid += lot.totalPaid || 0;
            salesBySeller[lot.seller].salesCommission += (lot.totalPaid || 0) * 0.10;
        }
    });

    activeGroups.forEach(group => {
        salesBySeller[group.seller].count += group.lotIds.length;
        salesBySeller[group.seller].totalPaid += group.totalPaid || 0;
        salesBySeller[group.seller].salesCommission += (group.totalPaid || 0) * 0.10;
    });

    returnedLots.forEach(lot => {
        if (!lot.groupId) {
            salesBySeller[lot.seller].returnCommission += lot.sellerCommission || 0;
        }
    });

    returnedGroups.forEach(group => {
        salesBySeller[group.seller].returnCommission += group.sellerCommission || 0;
    });

    const salesBySellerTableBody = document.getElementById('salesBySellerTableBody');
    salesBySellerTableBody.innerHTML = Object.entries(salesBySeller).map(([seller, data]) => `
        <tr>
            <td>${seller}</td>
            <td>${data.count}</td>
            <td>${formatNumber(data.totalPaid.toFixed(2))}</td>
            <td>${formatNumber(data.salesCommission.toFixed(2))}</td>
            <td>${formatNumber(data.returnCommission.toFixed(2))}</td>
        </tr>
    `).join('');

    // Actualizar tabla de ventas por tipo de pago
    const salesByPaymentType = { contado: 0, pagos: 0 };
    activeLots.forEach(lot => {
        if (!lot.groupId) salesByPaymentType[lot.paymentType]++;
    });
    activeGroups.forEach(group => {
        salesByPaymentType[group.paymentType] += group.lotIds.length;
    });

    const salesByPaymentTypeTableBody = document.getElementById('salesByPaymentTypeTableBody');
    salesByPaymentTypeTableBody.innerHTML = Object.entries(salesByPaymentType).map(([type, count]) => `
        <tr>
            <td>${type.charAt(0).toUpperCase() + type.slice(1)}</td>
            <td>${count}</td>
        </tr>
    `).join('');

    // Actualizar conteo de devoluciones
    document.getElementById('returnCount').textContent = returnedLots.filter(lot => !lot.groupId).length + returnedGroups.reduce((sum, group) => sum + group.lotIds.length, 0);
}

        function clearForm() {
            document.getElementById('lotId').value = '';
            document.getElementById('seller').value = sellers[0] || '';
            document.getElementById('buyerName').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('depositSlip').value = '';
            document.getElementById('receiptNumber').value = '';
            document.getElementById('saleDate').value = '';
            document.getElementById('paymentType').value = 'contado';
            document.getElementById('amountPaid').value = '';
            document.getElementById('numPayments').value = '';
            document.getElementById('lotValue').value = formatNumber(DEFAULT_LOT_PRICE);
            document.getElementById('totalValue').value = '0.00';
            document.getElementById('paymentDetails').style.display = 'none';
            document.getElementById('amountPaidContainer').style.display = 'none';
            document.getElementById('returnOption').style.display = 'none';
            document.getElementById('actionButton').textContent = 'Registrar Lote(s)';
            document.getElementById('actionButton').style.display = 'block';
            document.getElementById('lotDetails').style.display = 'none';
            document.getElementById('fullForm').style.display = 'block';
            document.getElementById('lotStatusLabel').textContent = '';
            document.getElementById('lotStatusLabel').style.display = 'none';
            document.getElementById('searchLot').value = '';
            currentLotGroup = null;
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            clearForm();
        }

        function exportToExcel() {
            const groupedLots = {};
            lotHistory.forEach(lot => {
                const key = lot.groupId ? lot.groupId : `single_${lot.id}`;
                if (!groupedLots[key]) {
                    if (lot.groupId) {
                        const group = lotGroups.find(g => g.groupId === lot.groupId);
                        groupedLots[key] = {
                            lotIds: group.lotIds,
                            status: group.status,
                            seller: group.seller,
                            buyerName: group.buyerName,
                            phoneNumber: group.phoneNumber,
                            depositSlip: group.depositSlip,
                            receiptNumber: group.receiptNumber,
                            saleDate: group.saleDate,
                            entryDate: group.entryDate,
                            paymentType: group.paymentType,
                            totalPaid: group.totalPaid || 0,
                            balance: group.balance || 0,
                            retainedAmount: group.retainedAmount || 0
                        };
                    } else {
                        groupedLots[key] = {
                            lotIds: [lot.id],
                            status: lot.status,
                            seller: lot.seller,
                            buyerName: lot.buyerName,
                            phoneNumber: lot.phoneNumber,
                            depositSlip: lot.depositSlip,
                            receiptNumber: lot.receiptNumber,
                            saleDate: lot.saleDate,
                            entryDate: lot.entryDate,
                            paymentType: lot.paymentType,
                            totalPaid: lot.totalPaid || 0,
                            balance: lot.balance || 0,
                            retainedAmount: lot.retainedAmount || 0
                        };
                    }
                }
            });

            const csvRows = [
                ['Número de Lote(s)', 'Estado', 'Vendedor', 'Comprador', 'Teléfono', 'Boleta de Depósito', 'Número de Recibo', 'Fecha de Venta', 'Fecha de Registro', 'Tipo de Pago', 'Monto Pagado (Q.)', 'Saldo Pendiente (Q.)', 'Monto Retenido (Q.)'],
                ...Object.values(groupedLots).map(group => [
                    group.lotIds.join(', ') || '',
                    (group.status || '').charAt(0).toUpperCase() + (group.status || '').slice(1),
                    group.seller || '',
                    group.buyerName || '',
                    group.phoneNumber || '',
                    group.depositSlip || '',
                    group.receiptNumber || '',
                    group.saleDate || '',
                    group.entryDate || '',
                    (group.paymentType || '').charAt(0).toUpperCase() + (group.paymentType || '').slice(1),
                    formatNumber(group.totalPaid.toFixed(2)),
                    formatNumber(group.balance.toFixed(2)),
                    formatNumber(group.retainedAmount.toFixed(2))
                ])
            ];

            const csvContent = csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lotes_registrados_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        window.onload = function() {
    if (totalLots > 0 && sellers.length > 0) {
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('controlScreen').style.display = 'block';
        initializeControlScreen();
    } else {
        document.getElementById('setupScreen').style.display = 'block';
        document.getElementById('controlScreen').style.display = 'none';
    }
};

        // Definir la disposición de la cuadrícula para el croquis
        const gridLayout = [
            Array.from({ length: 19 }, (_, i) => 227 + i), // Fila 1: 227-245
            Array.from({ length: 19 }, (_, i) => 226 - i), // Fila 2: 226-208 descendente
            Array.from({ length: 19 }, (_, i) => 189 + i), // Fila 3: 189-207
            Array.from({ length: 19 }, (_, i) => 188 - i), // Fila 4: 188-170 descendente
            Array.from({ length: 19 }, (_, i) => 151 + i), // Fila 5: 151-169
            Array.from({ length: 19 }, (_, i) => 150 - i), // Fila 6: 150-132 descendente
            Array.from({ length: 19 }, (_, i) => 113 + i), // Fila 7: 113-131
            Array.from({ length: 19 }, (_, i) => 112 - i), // Fila 8: 112-94 descendente
            Array.from({ length: 19 }, (_, i) => 75 + i),  // Fila 9: 75-93
            Array.from({ length: 19 }, (_, i) => 74 - i),  // Fila 10: 74-56 descendente
            Array.from({ length: 19 }, (_, i) => 37 + i),  // Fila 11: 37-55
            Array.from({ length: 18 }, (_, i) => 36 - i).concat([null]), // Fila 12: 36-19 descendente, null
            Array.from({ length: 18 }, (_, i) => 1 + i).concat([null])   // Fila 13: 1-18, null
        ];

        function updateCroquis() {
    const gridContainer = document.getElementById('gridContainer');
    gridContainer.innerHTML = '';
    const updateDate = document.getElementById('updateDate');
    const now = new Date().toLocaleString("es-GT", {
        timeZone: "America/Guatemala",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true
    });
    updateDate.textContent = `Última actualización: ${now}`;

    for (let row = 0; row < 13; row++) {
        for (let col = 0; col < 19; col++) {
            const lotId = gridLayout[row][col];
            if (lotId === null || lotId === undefined || lotId > totalLots) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.style.backgroundColor = '#E0E0E0'; // Color gris para deshabilitado
                gridContainer.appendChild(gridItem);
            } else {
                const lot = lots.find(l => l.id === lotId);
                const status = lot ? lot.status : 'disponible';
                const color = getColorByStatus(status);
                const tooltipText = getTooltipText(lot, status);

                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.style.backgroundColor = color;
                gridItem.textContent = lotId;
                gridItem.innerHTML += `<span class="tooltip">${tooltipText}</span>`;
                gridContainer.appendChild(gridItem);
            }
        }
    }
}
    
        function getColorByStatus(status) {
    switch (status) {
        case 'disponible':
        case 'devuelto':
            return '#34C759'; // Verde moderno para disponible y devuelto
        case 'vendido':
            return '#FF3B30'; // Rojo moderno para vendido
        case 'crédito':
            return '#FF9500'; // Naranja moderno para crédito
        default:
            return '#34C759';
    }
}
        function getTooltipText(lot, status) {
            if (!lot) {
                return 'Estado: Disponible';
            }
            return `
                Estado: ${status.charAt(0).toUpperCase() + status.slice(1)}<br>
                Vendedor: ${lot.seller || '-'}<br>
                Comprador: ${lot.buyerName || '-'}<br>
                Boleta: ${lot.depositSlip || '-'}
            `;
        }

        function exportCroquis() {
            const croquisElement = document.getElementById('croquis');
            html2canvas(croquisElement).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `croquis_lotes_${new Date().toISOString().slice(0, 10)}.png`;
                link.click();
            });
        }
    </script>
</body>
</html>
